<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Descifra el C√≥digo - Multijugador</title>
<link rel="icon" href="/logo.svg" type="image/svg+xml" />
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<script src="https://unpkg.com/react@18/umd/react.development.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<style>
  html { font-size: 16px; }
  @media (max-width: 640px) { html { font-size: 14px; } }
  
  .hidden-text {
    position: fixed; bottom: 0.5rem; left: 50%; transform: translateX(-50%);
    font-size: 0.75rem; color: rgba(255,255,255,0.6); opacity: 0;
    transition: opacity 1.3s ease; pointer-events: none; z-index: 20;
  }
  body:hover .hidden-text { opacity: 1; transition: opacity 0.8s ease-in; }
  body:not(:hover) .hidden-text { opacity: 0; transition: opacity 2.5s ease-out; }
  
  .fade { animation: fade 0.4s ease; }
  @keyframes fade { from { opacity: 0; } to { opacity: 1; } }
  
  @keyframes pulse-border {
    0% { border-color: rgba(6, 182, 212, 0.5); }
    50% { border-color: rgba(6, 182, 212, 1); }
    100% { border-color: rgba(6, 182, 212, 0.5); }
  }
  .pulse-border { animation: pulse-border 1.5s infinite ease-in-out; }
  
  .toast-container { position: fixed; top: 0.5rem; right: 0.5rem; z-index: 1000; }
  .toast {
    background-color: #333; color: white; padding: 0.5rem 1rem;
    border-radius: 0.5rem; margin-bottom: 0.5rem;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); animation: fade 0.3s ease-out;
    font-size: 0.875rem;
  }
  
  .drawer-slide { animation: fadeInDrawer .22s ease; }
  @keyframes fadeInDrawer { from { opacity: 0; transform: translateX(40px);} to { opacity: 1; transform: translateX(0);} }
  
  .note-card {
    background: rgba(45, 50, 64, 0.95); border: 1px solid rgba(119, 124, 124, 0.3);
    border-radius: 8px; padding: 0.75rem; margin-bottom: 0.75rem;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  }
  
  .note-title {
    font-size: 0.875rem; font-weight: 600; color: #1ccac6;
    margin-bottom: 0.5rem; display: flex; justify-content: space-between; align-items: center;
  }
  
  .note-content {
    font-size: 0.75rem; color: #e5e7eb; line-height: 1.4;
    max-height: 200px; overflow-y: auto;
  }
</style>
</head>
<body class="bg-gradient-to-b from-gray-900 to-black text-white">
<div id="root"></div>
<script type="text/babel">
const { useState, useEffect, useRef } = React;
const socket = io();

const LABELS = ['A', 'B', 'C', 'D', 'E'];

const Ficha = ({numero, color, oculta, index}) => {
  const base = "w-10 h-14 sm:w-12 sm:h-16 md:w-14 md:h-20 flex flex-col items-center justify-center rounded-lg m-1 border text-base sm:text-lg md:text-xl font-bold transition-all duration-300 fade relative"
  
  if (oculta) return (
    <div className={`${base} bg-gray-700 border-gray-600 text-gray-400`} style={{animationDelay: "0.15s"}}>
      <span className="text-xs absolute top-1 left-1.5 text-teal-300 font-semibold">{LABELS[index]}</span>
      <span>?</span>
    </div>
  );
  
  return (
    <div className={`${base} ${color==='blanco'?'bg-white text-black border-gray-400':'bg-black text-white border-gray-600'} hover:scale-105`}>
      <span className="text-xs absolute top-1 left-1.5 opacity-60">{LABELS[index]}</span>
      <span>{numero}</span>
    </div>
  );
};

const Mano = ({jugador, soyYo, esMiTurno, esCodigoOculto}) => (
  <div className={`p-2 sm:p-3 md:p-4 bg-gray-800/60 rounded-xl my-2 w-full fade ${esMiTurno ? 'border-2 border-teal-500 pulse-border' : ''} ${esCodigoOculto ? 'border border-yellow-500/50' : ''}`}>
    <h3 className="text-teal-300 font-semibold mb-2 text-base sm:text-lg">
      {jugador.name} {soyYo && '(T√∫)'} {esCodigoOculto && 'üîí'}
    </h3>
    <div className="flex justify-center flex-wrap w-full">
      {jugador.hand.map((t,i)=> <Ficha key={i} numero={t.numero} color={t.color} oculta={!soyYo && !esCodigoOculto} index={i}/>)}
    </div>
  </div>
);

const Toast = ({ message, type, onClose }) => {
  const bgColor = type === 'error' ? 'bg-red-700' : 'bg-green-700';
  return <div className={`toast ${bgColor}`} onClick={onClose}>{message}</div>;
};

const ToastContainer = ({ toasts, removeToast }) => (
  <div className="toast-container">
    {toasts.map(toast => <Toast key={toast.id} message={toast.message} type={toast.type} onClose={() => removeToast(toast.id)} />)}
  </div>
);

const Modal = ({show, title, body, onClose, modalType, onSubmitGuess}) => {
  if (!show) return null;
  const guessInputRef = useRef(null);

  const handleSubmit = () => {
    if (modalType === 'guess' && guessInputRef.current) {
      onSubmitGuess(guessInputRef.current.value);
    }
    onClose();
  };

  return (
    <div className="fixed inset-0 flex items-center justify-center bg-black/70 z-50 fade px-2">
      <div className="bg-gray-800 p-4 sm:p-6 rounded-xl w-full max-w-md border border-gray-600">
        <h2 className="text-lg sm:text-xl font-bold text-teal-400 mb-3">{title}</h2>
        <p className="whitespace-pre-line mb-4 text-sm sm:text-base">{body}</p>
        {modalType === 'guess' && (
          <div>
            <input ref={guessInputRef} type="text" maxLength="5"
              className="w-full p-2 text-black text-center rounded mb-2 bg-gray-200 text-base"
              placeholder="Ej. 12345"/>
            <button onClick={handleSubmit} className="w-full py-2 bg-rose-600 hover:bg-rose-500 rounded font-bold text-base">Enviar</button>
          </div>
        )}
        <button onClick={onClose} className="mt-3 w-full py-2 rounded bg-gray-700 hover:bg-gray-600 font-bold text-base">Cerrar</button>
      </div>
    </div>
  );
};

const NotesDrawer = ({visible, onClose, notas, toggleNota}) => {
  if (!visible) return null;
  return (
    <div className="fixed top-0 right-0 h-full w-11/12 sm:w-96 z-50 bg-gray-800/95 shadow-2xl flex flex-col drawer-slide overflow-hidden">
      <div className="flex items-center justify-between px-4 py-3 bg-gray-900 border-b border-gray-700">
        <h3 className="text-teal-400 font-semibold text-lg">Notas Privadas</h3>
        <button onClick={onClose} className="text-white text-2xl px-2 leading-none rounded hover:bg-gray-700">&times;</button>
      </div>
      <div className="p-4 overflow-y-auto flex-1">
        {notas.length === 0 && (
          <div className="text-gray-400 italic text-sm text-center mt-4">No hay notas todav√≠a.</div>
        )}
        {notas.map(n=>(
          <div key={n.id} className="note-card">
            <div className="note-title">
              <span className="flex-1">{n.title}</span>
              <button className="text-xs bg-emerald-600 px-2 py-1 rounded hover:bg-emerald-500 ml-2" onClick={()=>toggleNota(n.id)}>
                {n.abierta ? "Ocultar" : "Mostrar"}
              </button>
            </div>
            {n.abierta && <div className="note-content">{n.body}</div>}
          </div>
        ))}
      </div>
    </div>
  );
};

const NotesButton = ({onClick, hayNotas}) => (
  <button
    className="fixed top-3 right-3 z-40 bg-blue-600 text-white rounded-full shadow-lg w-14 h-14 flex flex-col items-center justify-center hover:bg-blue-700 transition-colors lg:hidden"
    onClick={onClick}
    style={{fontWeight: 'bold', fontSize:'20px'}}
    aria-label="Ver notas privadas"
  >
    <span>üìù</span>
    {hayNotas > 0 && <span className="text-xs">{hayNotas}</span>}
  </button>
);

const NotebookPanel = ({notas, toggleNota, customNotes, setCustomNotes}) => {
  const [newNote, setNewNote] = useState('');
  
  const addCustomNote = () => {
    if (newNote.trim()) {
      const id = Date.now();
      setCustomNotes(prev => [...prev, {id, content: newNote, timestamp: new Date().toLocaleTimeString()}]);
      setNewNote('');
    }
  };
  
  return (
    <div className="fixed left-0 top-0 h-full w-64 bg-gray-800/95 shadow-2xl flex flex-col overflow-hidden border-r border-gray-700 hidden lg:flex z-30">
      <div className="px-3 py-2 bg-gray-900 border-b border-gray-700">
        <h3 className="text-teal-400 font-semibold text-sm">üìù Bloc de Notas</h3>
      </div>
      
      <div className="flex-1 overflow-y-auto p-2">
        <div className="text-xs font-semibold text-gray-400 mb-2">Historial de Preguntas:</div>
        {notas.length === 0 && (
          <div className="text-gray-500 italic text-xs text-center my-2">Sin preguntas a√∫n</div>
        )}
        {notas.slice().reverse().map(n=>(
          <div key={n.id} className="bg-gray-700/50 rounded p-1.5 mb-2 text-xs">
            <div className="font-semibold text-teal-300 mb-1 cursor-pointer" onClick={()=>toggleNota(n.id)}>
              {n.abierta ? "‚ñº" : "‚ñ∂"} {n.title.substring(0, 30)}...
            </div>
            {n.abierta && <div className="text-gray-300 text-xs whitespace-pre-wrap">{n.body}</div>}
          </div>
        ))}
        
        <div className="text-xs font-semibold text-gray-400 mb-2 mt-4">Notas Personales:</div>
        {customNotes.map(cn=>(
          <div key={cn.id} className="bg-blue-900/30 rounded p-1.5 mb-2 text-xs border border-blue-700/50">
            <div className="text-blue-300 text-xs">{cn.content}</div>
            <div className="text-gray-500 text-xs mt-1">{cn.timestamp}</div>
          </div>
        ))}
      </div>
      
      <div className="p-2 border-t border-gray-700 bg-gray-900">
        <textarea 
          value={newNote}
          onChange={(e) => setNewNote(e.target.value)}
          placeholder="Escribe una nota..."
          className="w-full p-1.5 text-xs bg-gray-700 border border-gray-600 rounded text-white resize-none"
          rows="2"
        />
        <button 
          onClick={addCustomNote}
          className="w-full mt-1 py-1 text-xs bg-blue-600 hover:bg-blue-500 rounded font-semibold">
          A√±adir Nota
        </button>
      </div>
    </div>
  );
};

const ShareButton = ({sala, onCopyLink}) => (
  <button
    onClick={onCopyLink}
    className="flex items-center justify-center space-x-2 w-full mt-3 py-2 bg-blue-600 hover:bg-blue-500 rounded font-bold text-white transition-colors text-sm"
    title="Compartir enlace de la sala"
  >
    <svg className="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
      <path d="M15 8a3 3 0 10-2.977-2.63l-4.94 2.47a3 3 0 100 4.319l4.94 2.47a3 3 0 10.895-1.789l-4.94-2.47a3.027 3.027 0 000-.74l4.94-2.47C13.456 7.68 14.19 8 15 8z"/>
    </svg>
    <span>Compartir sala</span>
  </button>
);

const App = () => {
  const [nombre, setNombre] = useState('');
  const [sala, setSala] = useState('');
  const [jugadores, setJugadores] = useState([]);
  const [estado, setEstado] = useState(null);
  const [enPartida, setEnPartida] = useState(false);
  const [socketId, setSocketId] = useState(null);
  const [notasPrivadas, setNotasPrivadas] = useState([]);
  const [customNotes, setCustomNotes] = useState([]);
  const [esperandoCierre, setEsperandoCierre] = useState(false);
  const [modal, setModal] = useState({show:false, title:'', body:'', modalType:null});
  const [toasts, setToasts] = useState([]);
  const [showNotesDrawer, setShowNotesDrawer] = useState(false);
  const [esCreadorSala, setEsCreadorSala] = useState(false);

  const showToast = (message, type = 'info', duration = 3000) => {
    const id = Date.now();
    setToasts(prev => [...prev, { id, message, type }]);
    setTimeout(() => removeToast(id), duration);
  };
  const removeToast = (id) => { setToasts(prev => prev.filter(toast => toast.id !== id)); };

  useEffect(() => {
    socket.on('connect', () => setSocketId(socket.id));
    socket.on('updateRoom', players => {
      setJugadores(players);
      if (players.length === 1 && players[0].id === socket.id) {
        setEsCreadorSala(true);
      }
      if (enPartida && players.length < 2) {
        showToast("La partida termin√≥ porque no hay suficientes jugadores.", "error");
        setEnPartida(false); setEstado(null);
      }
    });
    socket.on('gameStarted', gs => {
      setEstado(gs); setEnPartida(true); setModal({show:false});
      showToast("¬°La partida ha comenzado!", "info");
      setNotasPrivadas([]);
    });
    socket.on('questionResult', r => {
      const id = Date.now();
      setNotasPrivadas(prev => [...prev, {id, title:r.title, body:r.body, abierta:true}]);
      
      if (r.autor === socket.id) {
        setModal({show:true, title:r.title, body:r.body, modalType:null});
        setEsperandoCierre(true);
      }
      
      setEstado(p => ({...p, usedQuestions:r.usedQuestions}));
    });
    socket.on('turnChanged', i => {
      setEstado(p => ({...p, currentPlayerTurn:i}));
      setEsperandoCierre(false);
    });
    socket.on('gameOver', ({winner, players}) => {
      const codigosTexto = players.map(p=>`${p.name}: ${p.code}`).join('\n');
      setModal({show:true, title:`üéâ ${winner.name} gan√≥!`, body:codigosTexto, modalType:null});
      setEnPartida(false); setEsperandoCierre(false);
    });
    socket.on('roomFull', () => showToast("La sala est√° llena, no puedes unirte.", "error"));
    socket.on('playerLeft', ({ playerName, newTurn }) => {
      showToast(`${playerName} ha abandonado la partida.`, "error");
      if (newTurn !== undefined) setEstado(prev => ({ ...prev, currentPlayerTurn: newTurn }));
    });
    return () => {
      socket.off('connect'); socket.off('updateRoom');
      socket.off('gameStarted'); socket.off('questionResult'); socket.off('turnChanged');
      socket.off('gameOver'); socket.off('roomFull'); socket.off('playerLeft');
    };
  }, [enPartida]);

  const unirse = () => {
    if (!nombre || !sala) { showToast("Introduce tu nombre y el c√≥digo de sala.", "error"); return; }
    socket.emit('joinRoom', {playerName:nombre, roomId:sala});
  };

  const copyShareLink = async () => {
    const shareUrl = `${window.location.origin}${window.location.pathname}?sala=${encodeURIComponent(sala)}`;
    try {
      await navigator.clipboard.writeText(shareUrl);
      showToast("¬°Enlace copiado al portapapeles!", "info");
    } catch (err) {
      const textArea = document.createElement('textarea');
      textArea.value = shareUrl;
      document.body.appendChild(textArea);
      textArea.select();
      document.execCommand('copy');
      document.body.removeChild(textArea);
      showToast("¬°Enlace copiado al portapapeles!", "info");
    }
  };

  useEffect(() => {
    const urlParams = new URLSearchParams(window.location.search);
    const salaParam = urlParams.get('sala');
    if (salaParam) setSala(salaParam);
  }, []);

  const comenzar = () => socket.emit('startGame', {roomId:sala});
  const esMiTurno = () => estado && socketId === estado.players[estado.currentPlayerTurn].id;
  const lanzarPregunta = i => {
    if (!esMiTurno() || esperandoCierre) return;
    socket.emit('selectQuestion', {roomId:sala, questionIndex:i});
  };
  const pasarTurno = () => { if (!esMiTurno()) return; socket.emit('closeQuestion', {roomId:sala}); };
  const handleSubmitGuess = (guess) => {
    if (guess && guess.length === 5 && /^\d+$/.test(guess)) {
      socket.emit("guessCode",{roomId:sala,guess:guess});
    } else { showToast("El c√≥digo debe ser de 5 d√≠gitos num√©ricos.", "error"); }
  };
  const abrirAdivinar = () => {
    if (!esMiTurno()) return;
    setModal({
      show:true, title:"Adivinar c√≥digo",
      body:"Introduce tu intento de c√≥digo (5 d√≠gitos num√©ricos):",
      modalType:"guess", onSubmitGuess: handleSubmitGuess
    });
  };
  const toggleNota = id => setNotasPrivadas(prev=>prev.map(p=>p.id===id?{...p,abierta:!p.abierta}:p));
  const totalPlayersInLobby = jugadores.length;
  const maxPlayers = 4;

  const manosAMostrar = estado ? [...estado.players] : [];
  if (estado && estado.mode === "missing" && estado.missing) {
    manosAMostrar.push({
      id: 'hidden',
      name: 'C√≥digo Oculto',
      hand: estado.missing.hand,
      code: estado.missing.code
    });
  }

  return (
    <div className="flex w-full min-h-screen">
      {enPartida && (
        <>
          <NotebookPanel 
            notas={notasPrivadas} 
            toggleNota={toggleNota}
            customNotes={customNotes}
            setCustomNotes={setCustomNotes}
          />
          <NotesButton onClick={()=>setShowNotesDrawer(true)} hayNotas={notasPrivadas.length}/>
          <NotesDrawer
            visible={showNotesDrawer}
            onClose={()=>setShowNotesDrawer(false)}
            notas={notasPrivadas}
            toggleNota={toggleNota}
          />
        </>
      )}
      
      <div className={`flex flex-col items-center justify-center w-full mx-auto p-3 sm:p-4 text-center min-h-screen ${enPartida ? 'lg:ml-64' : 'max-w-7xl'}`}>
        <h1 className="text-2xl sm:text-3xl font-bold text-teal-400 mb-3 sm:mb-4">Descifra el C√≥digo</h1>
        
        {!enPartida ? (
          <div className="bg-gray-800 p-4 sm:p-8 rounded-xl max-w-md w-full">
            <input placeholder="Tu nombre" className="w-full p-2 mb-2 bg-gray-700 border border-gray-600 rounded text-white" value={nombre} onChange={e=>setNombre(e.target.value)}/>
            <input placeholder="C√≥digo de sala" className="w-full p-2 mb-3 bg-gray-700 border border-gray-600 rounded text-white" value={sala} onChange={e=>setSala(e.target.value)}/>
            <button onClick={unirse} className="w-full bg-teal-600 hover:bg-teal-500 py-2 rounded font-semibold">Unirse</button>
            
            {esCreadorSala && totalPlayersInLobby >= 1 && sala && (
              <ShareButton sala={sala} onCopyLink={copyShareLink} />
            )}

            {totalPlayersInLobby > 0 && (
              <div className="mt-3 text-gray-300">
                <p className="font-semibold text-teal-300 mb-1">Jugadores en la sala ({totalPlayersInLobby}/{maxPlayers}):</p>
                {jugadores.map(j=><p key={j.id} className="text-sm">{j.name}</p>)}
              </div>
            )}
            {totalPlayersInLobby >= 2 && totalPlayersInLobby <= maxPlayers && (
              <button onClick={comenzar} className="w-full mt-3 bg-green-600 hover:bg-green-500 py-2 rounded font-semibold">Empezar partida</button>
            )}
          </div>
        ) : (
          estado && (
            <div className="fade w-full text-center">
              <h2 className="text-base sm:text-lg mb-2 sm:mb-3">Turno de: <span className={esMiTurno()?"text-green-400 font-bold":"text-yellow-400 font-bold"}>{estado.players[estado.currentPlayerTurn].name}</span></h2>
              
              <div className="grid grid-cols-1 md:grid-cols-2 gap-3 w-full mb-3">
                {manosAMostrar.map((p,i)=> {
                  const esCodigoOculto = p.id === 'hidden';
                  return <Mano key={p.id} jugador={p} soyYo={p.id===socketId} esMiTurno={p.id===socketId && esMiTurno()} esCodigoOculto={esCodigoOculto}/>
                })}
              </div>
              
              <div className="relative h-32 sm:h-40 md:h-48 flex justify-center items-center my-3">
                {estado.questions && estado.questions.map((q,i)=>{
                  if(estado.usedQuestions[i])return null;
                  const ang = (i - estado.questions.length / 2) * 5;
                  return (
                    <div key={i} onClick={()=>lanzarPregunta(i)}
                      className={`absolute left-1/2 top-1/2 w-20 h-12 sm:w-28 sm:h-16 md:w-36 md:h-20 flex items-center justify-center text-black font-bold rounded-lg shadow-md border text-xs sm:text-sm md:text-base
                        ${esMiTurno()&&!esperandoCierre?'bg-gradient-to-br from-teal-300 to-emerald-400 cursor-pointer hover:scale-105 transition-transform':'bg-gray-600 opacity-60 cursor-not-allowed'}`}
                      style={{
                        transform: `translate(-50%, -50%) rotate(${ang}deg)`,
                        zIndex: estado.questions.length - i
                      }}>
                      P {i + 1}
                    </div>
                  );
                })}
              </div>
              
              <div className="flex flex-col items-center w-full max-w-md mx-auto">
                <button disabled={!esMiTurno()} onClick={abrirAdivinar}
                  className={`mt-3 w-full py-2 rounded font-bold text-white ${esMiTurno()?'bg-rose-600 hover:bg-rose-500':'bg-gray-700 cursor-not-allowed'}`}>
                  Adivinar c√≥digo
                </button>
                <button disabled={!esMiTurno()} onClick={pasarTurno}
                  className={`mt-2 w-full py-2 rounded font-bold text-white ${esMiTurno()?'bg-yellow-600 hover:bg-yellow-500':'bg-gray-700 cursor-not-allowed'}`}>
                  Pasar turno
                </button>
              </div>
            </div>
        ))}
        
        <Modal show={modal.show} title={modal.title} body={modal.body} onClose={()=>setModal(m=>({...m,show:false}))}
              modalType={modal.modalType} onSubmitGuess={modal.onSubmitGuess}/>
        <ToastContainer toasts={toasts} removeToast={removeToast} />
        <div className="hidden-text">¬© 2025 Nahuel</div>
      </div>
    </div>
  );
};
const root = ReactDOM.createRoot(document.getElementById("root"));
root.render(<App />);
</script>
</body>
</html>
